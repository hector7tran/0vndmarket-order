<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEHC 0VND Market - Trang ƒë·∫∑t h√†ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FFF5F5; }
        .tet-gradient { background: linear-gradient(135deg, #D32F2F 0%, #B71C1C 100%); }
        .tab-active { border-bottom: 4px solid #FFD700; color: #FFD700; font-weight: bold; }
        .card-tet { border-top: 5px solid #FFD700; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    </style>
</head>
<body class="pb-20">

    <div id="loader" class="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-red-600"></div>
    </div>

    <header class="tet-gradient text-white p-6 text-center shadow-lg relative overflow-hidden">
        <div class="relative z-10">
            <h1 class="text-2xl font-bold uppercase tracking-wider">üèÆ SEHC 0VND Market üèÆ</h1>
            <p class="text-sm opacity-90">Xu√¢n ·∫§t T·ªµ 2025 - G√≥i tr·ªçn y√™u th∆∞∆°ng</p>
        </div>
        <span class="absolute top-2 left-2 text-2xl">üå∏</span>
        <span class="absolute bottom-2 right-2 text-2xl">üåº</span>
    </header>

    <nav class="flex bg-red-800 text-white sticky top-0 z-50">
        <button onclick="switchTab('order')" id="btn-order" class="flex-1 py-3 transition tab-active">ƒê·∫∂T H√ÄNG</button>
        <button onclick="switchTab('admin')" id="btn-admin" class="flex-1 py-3 transition">QU·∫¢N TR·ªä</button>
    </nav>

    <main class="max-w-md mx-auto p-4">
        
        <section id="tab-order" class="space-y-4">
            <div class="bg-white p-4 rounded-xl shadow-sm border card-tet">
                <a href="YOUR_PDF_URL_HERE" target="_blank" class="block w-full text-center bg-yellow-400 text-red-900 font-bold py-2 rounded-lg mb-4 hover:bg-yellow-500">
                    üìñ XEM CATALOG S·∫¢N PH·∫®M (PDF)
                </a>

                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700">M√£ nh√¢n vi√™n (8 s·ªë)</label>
                        <input type="number" id="empId" oninput="lookupEmployee(this.value)" class="w-full border p-3 rounded-lg mt-1 focus:ring-2 focus:ring-red-500 outline-none" placeholder="VD: 12345678">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700">H·ªç v√† t√™n</label>
                        <input type="text" id="empName" readonly class="w-full bg-gray-100 border p-3 rounded-lg mt-1 text-gray-600">
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700">Email</label>
                            <input type="email" id="email" class="w-full border p-3 rounded-lg mt-1 outline-none shadow-inner" placeholder="Email nh·∫≠n x√°c nh·∫≠n">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="tel" id="phone" class="w-full border p-3 rounded-lg mt-1 outline-none shadow-inner" placeholder="0xxx...">
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-sm border card-tet">
                <h3 class="font-bold text-red-700 mb-3 flex items-center">üõí Gi·ªè h√†ng <span id="cart-count" class="ml-2 bg-red-100 text-red-700 px-2 py-0.5 rounded-full text-xs">0</span></h3>
                <div class="flex gap-2 mb-4">
                    <select id="productSelect" class="flex-1 border p-2 rounded-lg text-sm outline-none"></select>
                    <button onclick="addToCart()" class="bg-red-600 text-white px-4 py-2 rounded-lg font-bold">+</button>
                </div>
                
                <div id="cartItems" class="divide-y text-sm">
                    </div>

                <div class="mt-4 pt-4 border-t flex justify-between items-center">
                    <span class="font-bold text-gray-700">T·ªîNG TI·ªÄN:</span>
                    <span id="totalPrice" class="text-xl font-bold text-red-600">0ƒë</span>
                </div>

                <button onclick="submitOrder()" class="w-full mt-6 bg-red-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg active:scale-95 transition">
                    X√ÅC NH·∫¨N ƒê·∫∂T H√ÄNG
                </button>
                <p class="text-center text-xs text-gray-500 mt-4">Hotline h·ªó tr·ª£: <a href="tel:0868203487" class="text-blue-600 font-bold">0868-203-487</a></p>
            </div>
        </section>

        <section id="tab-admin" class="hidden space-y-4">
            <div id="admin-login" class="bg-white p-8 rounded-xl shadow-sm border text-center">
                <h3 class="font-bold mb-4">X√°c th·ª±c quy·ªÅn Qu·∫£n tr·ªã</h3>
                <input type="password" id="adminPass" class="w-full border p-3 rounded-lg mb-4 text-center" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
                <button onclick="verifyAdmin()" class="w-full bg-gray-800 text-white py-2 rounded-lg">ƒêƒÉng nh·∫≠p</button>
            </div>

            <div id="admin-content" class="hidden space-y-4">
                <div class="grid grid-cols-3 gap-2">
                    <div class="bg-blue-50 p-3 rounded-lg text-center border border-blue-100">
                        <div id="stat-total" class="text-xl font-bold text-blue-700">0</div>
                        <div class="text-[10px] text-blue-600">ƒê√É ƒê·∫∂T</div>
                    </div>
                    <div class="bg-orange-50 p-3 rounded-lg text-center border border-orange-100">
                        <div id="stat-prep" class="text-xl font-bold text-orange-700">0</div>
                        <div class="text-[10px] text-orange-600">CHU·∫®N B·ªä</div>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg text-center border border-green-100">
                        <div id="stat-done" class="text-xl font-bold text-green-700">0</div>
                        <div class="text-[10px] text-green-600">ƒê√É NH·∫¨N</div>
                    </div>
                </div>
                <div id="orderList" class="space-y-3">
                    </div>
            </div>
        </section>
    </main>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyX45eLMSESi_fqElh0y3Au1fPqZdugWBjMeB96ap6ruIYsHkosKvu5ECdnAYn78xzi/exec';
        let APP_DATA = { employees: [], products: [], cart: [], orders: [] };

        window.onload = async () => {
            try {
                const resp = await fetch(`${API_URL}?action=initData`);
                const data = await resp.json();
                APP_DATA.employees = data.employees;
                APP_DATA.products = data.products;
                
                // Render products to select
                const select = document.getElementById('productSelect');
                APP_DATA.products.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.ProductID;
                    opt.textContent = `${p.ProductName} - ${p.Price.toLocaleString()}ƒë`;
                    select.appendChild(opt);
                });
                
                document.getElementById('loader').classList.add('hidden');
            } catch (e) {
                console.error("Load failed", e);
                Swal.fire("L·ªói", "Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra internet.", "error");
            }
        };

        function switchTab(tab) {
            document.getElementById('tab-order').classList.toggle('hidden', tab !== 'order');
            document.getElementById('tab-admin').classList.toggle('hidden', tab !== 'admin');
            document.getElementById('btn-order').className = tab === 'order' ? 'flex-1 py-3 transition tab-active' : 'flex-1 py-3 transition';
            document.getElementById('btn-admin').className = tab === 'admin' ? 'flex-1 py-3 transition tab-active' : 'flex-1 py-3 transition';
        }

        function lookupEmployee(id) {
            if (id.length === 8) {
                const emp = APP_DATA.employees.find(e => String(e.EmployeeID) === id);
                if (emp) {
                    document.getElementById('empName').value = emp.FullName;
                    return;
                }
            }
            document.getElementById('empName').value = "";
        }

        function addToCart() {
            const pid = document.getElementById('productSelect').value;
            const product = APP_DATA.products.find(p => p.ProductID == pid);
            const existing = APP_DATA.cart.find(c => c.id == pid);
            
            if (existing) existing.qty++;
            else APP_DATA.cart.push({ id: pid, name: product.ProductName, price: product.Price, qty: 1 });
            
            renderCart();
        }

        function renderCart() {
            const container = document.getElementById('cartItems');
            container.innerHTML = APP_DATA.cart.map((item, idx) => `
                <div class="flex justify-between items-center py-2">
                    <div>
                        <div class="font-semibold">${item.name}</div>
                        <div class="text-xs text-gray-500">${item.price.toLocaleString()}ƒë x ${item.qty}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="updateQty(${idx}, -1)" class="w-6 h-6 bg-gray-200 rounded text-sm">-</button>
                        <span>${item.qty}</span>
                        <button onclick="updateQty(${idx}, 1)" class="w-6 h-6 bg-gray-200 rounded text-sm">+</button>
                    </div>
                </div>
            `).join('');
            
            const total = APP_DATA.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            document.getElementById('totalPrice').textContent = total.toLocaleString() + 'ƒë';
            document.getElementById('cart-count').textContent = APP_DATA.cart.length;
        }

        function updateQty(idx, delta) {
            APP_DATA.cart[idx].qty += delta;
            if (APP_DATA.cart[idx].qty <= 0) APP_DATA.cart.splice(idx, 1);
            renderCart();
        }

        async function submitOrder() {
            const orderData = {
                action: 'createOrder',
                empId: document.getElementById('empId').value,
                empName: document.getElementById('empName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                cart: APP_DATA.cart,
                total: APP_DATA.cart.reduce((sum, item) => sum + (item.price * item.qty), 0)
            };

            if (!orderData.empId || !orderData.email || orderData.cart.length === 0) {
                return Swal.fire("Thi·∫øu th√¥ng tin", "Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß v√† ch·ªçn h√†ng", "warning");
            }

            // OPTIMISTIC UI: Show success immediately
            Swal.fire({
                title: "Th√†nh c√¥ng!",
                text: "ƒê∆°n h√†ng ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω ng·∫ßm. Vui l√≤ng check email sau √≠t ph√∫t.",
                icon: "success",
                confirmButtonColor: "#D32F2F"
            });

            // G·ª≠i ng·∫ßm
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(orderData)
            }).then(() => {
                // Reset form
                APP_DATA.cart = [];
                renderCart();
                document.getElementById('empId').value = "";
                document.getElementById('empName').value = "";
            });
        }

        // ADMIN LOGIC
        function verifyAdmin() {
            if (document.getElementById('adminPass').value === "8888") {
                document.getElementById('admin-login').classList.add('hidden');
                document.getElementById('admin-content').classList.remove('hidden');
                loadAdminOrders();
            } else {
                Swal.fire("Sai m·∫≠t kh·∫©u", "M·∫≠t kh·∫©u qu·∫£n tr·ªã l√† 8888", "error");
            }
        }

        async function loadAdminOrders() {
            const resp = await fetch(`${API_URL}?action=getOrders`);
            const orders = await resp.json();
            APP_DATA.orders = orders;
            
            // Stats
            document.getElementById('stat-total').textContent = orders.length;
            document.getElementById('stat-prep').textContent = orders.filter(o => o.Status === 'ƒê√£ chu·∫©n b·ªã').length;
            document.getElementById('stat-done').textContent = orders.filter(o => o.Status === 'ƒê√£ nh·∫≠n').length;

            const container = document.getElementById('orderList');
            container.innerHTML = orders.reverse().map(o => `
                <div class="bg-white p-3 rounded-lg border shadow-sm text-sm">
                    <div class="flex justify-between border-b pb-1 mb-2">
                        <span class="font-bold text-red-700">${o.OrderID}</span>
                        <span class="text-[10px] text-gray-500">${new Date(o.Timestamp).toLocaleString()}</span>
                    </div>
                    <p><b>${o.EmployeeName}</b> (${o.EmployeeID})</p>
                    <p class="text-xs text-gray-600">ƒêT: ${o.Phone}</p>
                    <div class="mt-2">
                        <input type="text" placeholder="H·∫πn gi·ªù nh·∫≠n..." id="time-${o.OrderID}" value="${o.PickupTime || ''}" class="w-full border p-2 rounded text-xs">
                    </div>
                    <div class="flex gap-2 mt-2">
                        <button onclick="updateStatus('${o.OrderID}', 'ƒê√£ chu·∫©n b·ªã')" class="flex-1 bg-yellow-500 text-white py-1 rounded text-xs">Chu·∫©n b·ªã</button>
                        <button onclick="updateStatus('${o.OrderID}', 'ƒê√£ nh·∫≠n')" class="flex-1 bg-green-600 text-white py-1 rounded text-xs">ƒê√£ nh·∫≠n</button>
                        <button onclick="updateStatus('${o.OrderID}', 'ƒê√£ h·ªßy')" class="flex-1 bg-gray-400 text-white py-1 rounded text-xs">H·ªßy</button>
                    </div>
                </div>
            `).join('');
        }

        async function updateStatus(orderId, status) {
            const pickupTime = document.getElementById(`time-${orderId}`).value;
            Swal.fire({ title: 'ƒêang c·∫≠p nh·∫≠t...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'updateOrder', orderId, status, pickupTime })
            });
            
            Swal.fire("ƒê√£ c·∫≠p nh·∫≠t", `ƒê∆°n h√†ng ${orderId} -> ${status}`, "success");
            loadAdminOrders();
        }
    </script>
</body>
</html>